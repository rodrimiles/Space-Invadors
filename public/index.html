<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Space Invaders Coop</title>
  <!-- Using Orbitron font for a futuristic look -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
  <style>
    /* General Styles */
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #000 0%, #222 100%);
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      text-align: center;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      cursor: pointer;
      background-color: #555;
      color: #fff;
      border: none;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #777;
    }
    canvas {
      border: 2px solid #fff;
      background: #000;
      display: block;
      margin: 20px auto;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
    }
    /* Landing / Menu Screens */
    #landing, #multiplayerOptions, #waitingScreen, #gameContainer {
      padding: 20px;
    }
    /* In-Game UI */
    #shop {
      text-align: center;
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(50, 50, 50, 0.95);
      color: #fff;
      padding: 30px;
      border: 2px solid #fff;
      border-radius: 10px;
      z-index: 100;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
    }
    .powerup {
      display: inline-block;
      margin: 10px;
      padding: 10px 15px;
      border: 1px solid #fff;
      cursor: pointer;
      background-color: #333;
      color: #fff;
      transition: background-color 0.3s;
      border-radius: 5px;
    }
    .powerup:hover {
      background-color: #555;
    }
    #shop button {
      margin-top: 15px;
      padding: 10px 15px;
      cursor: pointer;
      background-color: #555;
      color: #fff;
      border: none;
      transition: background-color 0.3s;
      border-radius: 5px;
    }
    #shop button:hover {
      background-color: #777;
    }
    #info {
      margin-top: 10px;
      color: #fff;
    }
    #info span {
      margin: 0 10px;
    }
    #shieldCooldown {
      display: none;
      margin-top: 10px;
      color: #fff;
    }
    /* Game Over Popup */
    #gameOverPopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(50, 50, 50, 0.95);
      color: #fff;
      padding: 30px;
      border: 2px solid #fff;
      border-radius: 10px;
      text-align: center;
      z-index: 100;
    }
    #gameOverPopup button {
      margin: 10px;
      padding: 10px 15px;
      cursor: pointer;
      background-color: #555;
      color: #fff;
      border: none;
      transition: background-color 0.3s;
      border-radius: 5px;
    }
    #gameOverPopup button:hover {
      background-color: #777;
    }
  </style>
</head>
<body>
  <!-- Landing Screen -->
  <div id="landing">
    <h1>Space Invaders Coop</h1>
    <button onclick="selectMode('singleplayer')">Singleplayer</button>
    <button onclick="selectMode('multiplayer')">Multiplayer</button>
  </div>

  <!-- Multiplayer Options Screen -->
  <div id="multiplayerOptions" style="display: none;">
    <h2>Multiplayer Options</h2>
    <button onclick="selectMultiplayer('online')">Online</button>
    <button onclick="selectMultiplayer('local')">Local Multiplayer</button>
    <button onclick="backToLanding()">Back</button>
  </div>

  <!-- Waiting Screen for Online Multiplayer -->
  <div id="waitingScreen" style="display: none;">
    <h2>Waiting for other player...</h2>
    <button onclick="cancelWaiting()">Cancel</button>
  </div>

  <!-- Game Container -->
  <div id="gameContainer" style="display: none;">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <button id="shopButton" onclick="toggleShop()">Shop (S)</button>
    <button id="fullscreenButton" onclick="toggleFullscreen()">Fullscreen (F)</button>
    <div id="shop">
      <h2>Shop</h2>
      <div class="powerup" onclick="buyPowerup('speed')">Speed Boost (500 pts)</div>
      <div class="powerup" onclick="buyPowerup('shield')">Shield (250 pts)</div>
      <div class="powerup" onclick="buyPowerup('doubleShot')">Double Shot (1000 pts)</div>
      <br>
      <button onclick="toggleShop()">Close</button>
    </div>
    <div id="info">
      <span id="lives">Lives: </span>
      <span id="score">Score: 0</span>
      <span id="level">Level: 1</span>
    </div>
    <div id="shieldCooldown">Shield Cooldown: <span id="shieldCooldownTime">30</span>s</div>
    <div id="gameOverPopup">
      <h2>Game Over</h2>
      <p id="finalScore"></p>
      <button onclick="playAgain()">Play Again</button>
      <button onclick="leaveGame()">Leave</button>
    </div>
  </div>

  <script>
    // Global gameMode can be:
    // "singleplayer", "multiplayer_online", or "multiplayer_local"
    let gameMode = "";
    function selectMode(mode) {
      if (mode === "singleplayer") {
        gameMode = "singleplayer";
        startGame();
      } else if (mode === "multiplayer") {
        document.getElementById("landing").style.display = "none";
        document.getElementById("multiplayerOptions").style.display = "block";
      }
    }
    function selectMultiplayer(option) {
      if (option === "online") {
        gameMode = "multiplayer_online";
        document.getElementById("multiplayerOptions").style.display = "none";
        document.getElementById("waitingScreen").style.display = "block";
        // (For this demo, online functionality isn’t implemented.)
      } else if (option === "local") {
        gameMode = "multiplayer_local";
        startGame();
      }
    }
    function cancelWaiting() {
      gameMode = "";
      document.getElementById("waitingScreen").style.display = "none";
      document.getElementById("landing").style.display = "block";
    }
    function backToLanding() {
      document.getElementById("multiplayerOptions").style.display = "none";
      document.getElementById("landing").style.display = "block";
    }
    function startGame() {
      document.getElementById("landing").style.display = "none";
      document.getElementById("multiplayerOptions").style.display = "none";
      document.getElementById("waitingScreen").style.display = "none";
      document.getElementById("gameContainer").style.display = "block";
      initGame();
    }
  </script>

  <script>
    /* --------------------- GAME CODE --------------------- */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let animationFrameId;
    let gamePaused = false;
    let boss = null;
    let invaderLevel = 1;
    let invaderSpeed = 2;
    let invaderDirection = 1;
    let teamScore = 0;
    let verticalMoveCount = 0;
    // Powerups available via shop (applies to all modes)
    const powerups = { speed: false, shield: false, doubleShot: false };

    // Player objects – in singleplayer only player1 is used.
    let player1, player2;
    // (They will be initialized in initGame())

    // Update info display (lives, score, level)
    function updateInfoDisplay() {
      if (gameMode === "singleplayer") {
        document.getElementById('lives').innerText = `Lives: ${player1.lives}`;
      } else {
        document.getElementById('lives').innerText = `P1 Lives: ${player1.lives} | P2 Lives: ${player2.lives}`;
      }
      document.getElementById('score').innerText = `Score: ${teamScore}`;
      document.getElementById('level').innerText = `Level: ${invaderLevel}`;
    }

    // Shop powerup purchase
    function buyPowerup(type) {
      if (type === 'speed') {
        if (teamScore >= 500 && !powerups.speed) {
          teamScore -= 500;
          powerups.speed = true;
          player1.speed = 10;
          if (player2) player2.speed = 10;
          updateInfoDisplay();
        } else {
          alert("Not enough points for Speed Boost or already purchased!");
        }
      } else if (type === 'shield') {
        if (teamScore >= 250 && !powerups.shield) {
          teamScore -= 250;
          powerups.shield = true;
          activateShield();
          updateInfoDisplay();
        } else {
          alert("Not enough points for Shield or already purchased!");
        }
      } else if (type === 'doubleShot') {
        if (teamScore >= 1000 && !powerups.doubleShot) {
          teamScore -= 1000;
          powerups.doubleShot = true;
          updateInfoDisplay();
        } else {
          alert("Not enough points for Double Shot or already purchased!");
        }
      }
    }

    // Activate shield for all players
    function activateShield() {
      if (player1) { player1.shieldActive = true; player1.shieldCooldown = true; }
      if (player2) { player2.shieldActive = true; player2.shieldCooldown = true; }
      document.getElementById('shieldCooldown').style.display = 'block';
      let cooldownTime = 30;
      const cooldownInterval = setInterval(() => {
        cooldownTime--;
        document.getElementById('shieldCooldownTime').innerText = cooldownTime;
        if (cooldownTime <= 0) {
          clearInterval(cooldownInterval);
          if (player1) player1.shieldCooldown = false;
          if (player2) player2.shieldCooldown = false;
          document.getElementById('shieldCooldown').style.display = 'none';
        }
      }, 1000);
      setTimeout(() => {
        if (player1) player1.shieldActive = false;
        if (player2) player2.shieldActive = false;
      }, 5000);
    }

    // Toggle shop popup (pausing/resuming the game)
    function toggleShop() {
      const shop = document.getElementById('shop');
      if (shop.style.display === 'none' || shop.style.display === '') {
        shop.style.display = 'block';
        gamePaused = true;
        cancelAnimationFrame(animationFrameId);
      } else {
        shop.style.display = 'none';
        gamePaused = false;
        draw();
      }
    }

    // Fullscreen toggle
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        canvas.requestFullscreen().catch(err => { alert(`Error: ${err.message}`); });
      } else {
        document.exitFullscreen();
      }
    }

    /* ---------- Input Handling ---------- */
    // For singleplayer: use arrow keys for movement, Enter (or NumpadEnter) for shooting.
    // For multiplayer_local: Player 1 uses Arrow keys/Enter, Player 2 uses A/D for movement and Space to shoot.
    const keysP1 = {};
    const keysP2 = {};
    document.addEventListener('keydown', (e) => {
      // Global shortcuts
      if (e.key.toLowerCase() === 'f') toggleFullscreen();
      if (e.key.toLowerCase() === 's') toggleShop();

      if (gameMode === "singleplayer") {
        if (e.code === "ArrowLeft" || e.code === "ArrowRight" ||
            e.code === "Enter" || e.code === "NumpadEnter") {
          keysP1[e.code] = true;
        }
      } else if (gameMode === "multiplayer_local") {
        if (e.code === "ArrowLeft" || e.code === "ArrowRight" ||
            e.code === "Enter" || e.code === "NumpadEnter") {
          keysP1[e.code] = true;
        }
        if (e.code === "KeyA" || e.code === "KeyD" || e.code === "Space") {
          keysP2[e.code] = true;
        }
      }
    });
    document.addEventListener('keyup', (e) => {
      if (gameMode === "singleplayer") {
        if (e.code === "ArrowLeft" || e.code === "ArrowRight" ||
            e.code === "Enter" || e.code === "NumpadEnter") {
          keysP1[e.code] = false;
        }
      } else if (gameMode === "multiplayer_local") {
        if (e.code === "ArrowLeft" || e.code === "ArrowRight" ||
            e.code === "Enter" || e.code === "NumpadEnter") {
          keysP1[e.code] = false;
        }
        if (e.code === "KeyA" || e.code === "KeyD" || e.code === "Space") {
          keysP2[e.code] = false;
        }
      }
    });

    /* ---------- Bullets ---------- */
    let bullets = [];
    let invaderBullets = [];
    function shoot(player) {
      const bullet = { x: player.x + player.width/2, y: player.y, speed: 7 };
      bullets.push(bullet);
      if (powerups.doubleShot) {
        const bullet2 = { x: player.x + player.width/2 - 10, y: player.y, speed: 7 };
        bullets.push(bullet2);
      }
    }

    /* ---------- Invaders & Boss ---------- */
    let invaders = [];
    const invaderRows = 3;
    const invaderCols = 10;
    const invaderWidth = 40;
    const invaderHeight = 20;
    const invaderPadding = 10;
    const invaderOffsetTop = 50;
    const invaderOffsetLeft = 50;
    function createInvaders() {
      boss = null;
      if ([5,10,15,20].includes(invaderLevel)) {
        let bossHealth = 20 + (invaderLevel - 5) * 5;
        boss = { x: canvas.width/2 - 100, y: 50, width: 200, height: 50, alive: true, health: bossHealth };
        invaders = [];
      } else {
        invaders = [];
        for (let i = 0; i < invaderCols; i++) {
          invaders[i] = [];
          for (let j = 0; j < invaderRows; j++) {
            invaders[i][j] = { 
              x: i * (invaderWidth + invaderPadding) + invaderOffsetLeft, 
              y: j * (invaderHeight + invaderPadding) + invaderOffsetTop, 
              alive: true, 
              health: invaderLevel 
            };
          }
        }
      }
      updateInfoDisplay();
    }
    createInvaders();

    function drawInvader(invader) {
      let gradient = ctx.createRadialGradient(
        invader.x + invaderWidth/2, invader.y + invaderHeight/2, 5,
        invader.x + invaderWidth/2, invader.y + invaderHeight/2, invaderWidth/2
      );
      gradient.addColorStop(0, '#00FF00');
      gradient.addColorStop(1, '#006600');
      ctx.fillStyle = gradient;
      ctx.fillRect(invader.x, invader.y, invaderWidth, invaderHeight);
      if (invader.health > 1) {
        ctx.strokeStyle = '#FFFFFF';
        ctx.lineWidth = 2;
        ctx.strokeRect(invader.x, invader.y, invaderWidth, invaderHeight);
      }
    }
    function drawBoss(boss) {
      let gradient = ctx.createRadialGradient(
        boss.x + boss.width/2, boss.y + boss.height/2, 10,
        boss.x + boss.width/2, boss.y + boss.height/2, boss.width/2
      );
      gradient.addColorStop(0, '#FF0000');
      gradient.addColorStop(1, '#660000');
      ctx.fillStyle = gradient;
      ctx.fillRect(boss.x, boss.y, boss.width, boss.height);
      ctx.strokeStyle = '#FFFFFF';
      ctx.lineWidth = 3;
      ctx.strokeRect(boss.x, boss.y, boss.width, boss.height);
      // Health bar
      ctx.fillStyle = '#FFF';
      ctx.fillRect(boss.x, boss.y - 10, boss.width, 5);
      ctx.fillStyle = '#0F0';
      let maxHealth = 20 + (invaderLevel - 5) * 5;
      ctx.fillRect(boss.x, boss.y - 10, boss.width * (boss.health / maxHealth), 5);
    }
    function drawInvaders() {
      if (boss) {
        drawBoss(boss);
      } else {
        for (let i = 0; i < invaderCols; i++) {
          for (let j = 0; j < invaderRows; j++) {
            if (invaders[i][j].alive) {
              drawInvader(invaders[i][j]);
            }
          }
        }
      }
    }
    function updateInvaders() {
      if (boss) {
        boss.x += invaderDirection * invaderSpeed;
        if (boss.x + boss.width > canvas.width || boss.x < 0) {
          invaderDirection *= -1;
        }
        if (Math.random() < 0.005 * invaderLevel) {
          invaderBullets.push({ x: boss.x + boss.width/2, y: boss.y + boss.height, speed: 4 });
        }
      } else {
        let edgeReached = false;
        for (let i = 0; i < invaderCols; i++) {
          for (let j = 0; j < invaderRows; j++) {
            if (invaders[i][j].alive) {
              invaders[i][j].x += invaderDirection * invaderSpeed;
              if (invaders[i][j].x + invaderWidth > canvas.width || invaders[i][j].x < 0) {
                edgeReached = true;
              }
              if (Math.random() < 0.002 * invaderLevel) {
                invaderBullets.push({ x: invaders[i][j].x + invaderWidth/2, y: invaders[i][j].y + invaderHeight, speed: 3 });
              }
            }
          }
        }
        if (edgeReached) {
          invaderDirection *= -1;
          for (let i = 0; i < invaderCols; i++) {
            for (let j = 0; j < invaderRows; j++) {
              invaders[i][j].y += invaderHeight;
            }
          }
        }
      }
    }
    function updateBullets() {
      // Player bullets
      for (let i = bullets.length - 1; i >= 0; i--) {
        const bullet = bullets[i];
        bullet.y -= bullet.speed;
        if (boss && boss.alive &&
            bullet.x > boss.x && bullet.x < boss.x + boss.width &&
            bullet.y > boss.y && bullet.y < boss.y + boss.height) {
          boss.health -= 1;
          if (boss.health <= 0) { boss.alive = false; teamScore += 5; updateInfoDisplay(); }
          bullets.splice(i, 1);
          continue;
        }
        for (let col = 0; col < invaderCols; col++) {
          for (let row = 0; row < invaderRows; row++) {
            const invader = invaders[col][row];
            if (invader.alive &&
                bullet.x > invader.x && bullet.x < invader.x + invaderWidth &&
                bullet.y > invader.y && bullet.y < invader.y + invaderHeight) {
              invader.health -= 1;
              if (invader.health <= 0) { invader.alive = false; teamScore += 5; updateInfoDisplay(); }
              bullets.splice(i, 1);
              break;
            }
          }
        }
        if (bullet.y < 0) { bullets.splice(i, 1); }
      }
      // Invader (and boss) bullets
      for (let i = invaderBullets.length - 1; i >= 0; i--) {
        const bullet = invaderBullets[i];
        bullet.y += bullet.speed;
        if (gameMode === "singleplayer") {
          if (bullet.x > player1.x && bullet.x < player1.x + player1.width &&
              bullet.y > player1.y && bullet.y < player1.y + player1.height) {
            invaderBullets.splice(i, 1);
            if (!player1.shieldActive) { player1.lives--; updateInfoDisplay(); }
          }
        } else {
          if (bullet.x > player1.x && bullet.x < player1.x + player1.width &&
              bullet.y > player1.y && bullet.y < player1.y + player1.height) {
            invaderBullets.splice(i, 1);
            if (!player1.shieldActive) { player1.lives--; updateInfoDisplay(); }
          }
          if (bullet.x > player2.x && bullet.x < player2.x + player2.width &&
              bullet.y > player2.y && bullet.y < player2.y + player2.height) {
            invaderBullets.splice(i, 1);
            if (!player2.shieldActive) { player2.lives--; updateInfoDisplay(); }
          }
        }
        if (bullet.y > canvas.height) { invaderBullets.splice(i, 1); }
      }
    }
    function checkAllEnemiesDefeated() {
      if (boss) return !boss.alive;
      for (let i = 0; i < invaderCols; i++) {
        for (let j = 0; j < invaderRows; j++) {
          if (invaders[i][j].alive) return false;
        }
      }
      return true;
    }
    function gameOver() {
      document.getElementById('gameOverPopup').style.display = 'block';
      document.getElementById('finalScore').innerText = `Your Score: ${teamScore}`;
      cancelAnimationFrame(animationFrameId);
    }
    function playAgain() {
      document.getElementById('gameOverPopup').style.display = 'none';
      if (gameMode === "singleplayer") {
        player1.lives = 3;
        player1.x = canvas.width/2 - 20;
      } else {
        player1.lives = player2.lives = 3;
        player1.x = canvas.width/2 - 100;
        player2.x = canvas.width/2 + 60;
      }
      teamScore = 0;
      invaderLevel = 1;
      invaderSpeed = 2;
      invaderDirection = 1;
      boss = null;
      bullets = [];
      invaderBullets = [];
      createInvaders();
      updateInfoDisplay();
      draw();
    }
    function leaveGame() {
      window.location.href = "about:blank";
    }
    function handlePlayerMovement() {
      if (gameMode === "singleplayer") {
        if (keysP1["ArrowLeft"]) { player1.x -= player1.speed; if (player1.x < 0) player1.x = 0; }
        if (keysP1["ArrowRight"]) { player1.x += player1.speed; if (player1.x + player1.width > canvas.width) player1.x = canvas.width - player1.width; }
        if (keysP1["Enter"] || keysP1["NumpadEnter"]) { shoot(player1); keysP1["Enter"] = keysP1["NumpadEnter"] = false; }
      } else if (gameMode === "multiplayer_local") {
        // Player 1
        if (keysP1["ArrowLeft"]) { player1.x -= player1.speed; if (player1.x < 0) player1.x = 0; }
        if (keysP1["ArrowRight"]) { player1.x += player1.speed; if (player1.x + player1.width > canvas.width) player1.x = canvas.width - player1.width; }
        if (keysP1["Enter"] || keysP1["NumpadEnter"]) { shoot(player1); keysP1["Enter"] = keysP1["NumpadEnter"] = false; }
        // Player 2
        if (keysP2["KeyA"]) { player2.x -= player2.speed; if (player2.x < 0) player2.x = 0; }
        if (keysP2["KeyD"]) { player2.x += player2.speed; if (player2.x + player2.width > canvas.width) player2.x = canvas.width - player2.width; }
        if (keysP2["Space"]) { shoot(player2); keysP2["Space"] = false; }
      }
    }
    function draw() {
      if (gamePaused) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      handlePlayerMovement();
      drawInvaders();
      updateBullets();
      ctx.fillStyle = 'yellow';
      bullets.forEach(bullet => { ctx.fillRect(bullet.x, bullet.y, 5, 10); });
      ctx.fillStyle = 'red';
      invaderBullets.forEach(bullet => { ctx.fillRect(bullet.x, bullet.y, 5, 10); });
      if (gameMode === "singleplayer") {
        ctx.fillStyle = 'white';
        ctx.fillRect(player1.x, player1.y, player1.width, player1.height);
        if (player1.shieldActive) {
          ctx.strokeStyle = 'blue';
          ctx.lineWidth = 3;
          ctx.strokeRect(player1.x - 5, player1.y - 5, player1.width + 10, player1.height + 10);
        }
      } else {
        ctx.fillStyle = 'white';
        ctx.fillRect(player1.x, player1.y, player1.width, player1.height);
        if (player1.shieldActive) {
          ctx.strokeStyle = 'blue';
          ctx.lineWidth = 3;
          ctx.strokeRect(player1.x - 5, player1.y - 5, player1.width + 10, player1.height + 10);
        }
        ctx.fillStyle = 'cyan';
        ctx.fillRect(player2.x, player2.y, player2.width, player2.height);
        if (player2.shieldActive) {
          ctx.strokeStyle = 'blue';
          ctx.lineWidth = 3;
          ctx.strokeRect(player2.x - 5, player2.y - 5, player2.width + 10, player2.height + 10);
        }
      }
      updateInvaders();
      if (checkAllEnemiesDefeated()) {
        invaderLevel++;
        invaderSpeed += 0.5;
        createInvaders();
      }
      if ((gameMode === "singleplayer" && player1.lives <= 0) ||
          (gameMode !== "singleplayer" && player1.lives <= 0 && player2.lives <= 0)) {
        gameOver();
        return;
      }
      animationFrameId = requestAnimationFrame(draw);
    }
    function initGame() {
      if (gameMode === "singleplayer") {
        player1 = { x: canvas.width/2 - 20, y: canvas.height - 50, width: 40, height: 20, speed: 5, lives: 3, shieldActive: false, shieldCooldown: false };
      } else if (gameMode === "multiplayer_local") {
        player1 = { x: canvas.width/2 - 100, y: canvas.height - 50, width: 40, height: 20, speed: 5, lives: 3, shieldActive: false, shieldCooldown: false };
        player2 = { x: canvas.width/2 + 60, y: canvas.height - 50, width: 40, height: 20, speed: 5, lives: 3, shieldActive: false, shieldCooldown: false };
      }
      teamScore = 0;
      invaderLevel = 1;
      invaderSpeed = 2;
      invaderDirection = 1;
      boss = null;
      bullets = [];
      invaderBullets = [];
      createInvaders();
      updateInfoDisplay();
      draw();
    }
  </script>
</body>
</html>
